---
# App role - Deploy Space2Study application stack
# Uses local repos synced via Vagrant instead of cloning from GitHub

# Build Docker images from synced local repos
- name: Build backend Docker image
  community.docker.docker_image:
    name: "{{ backend_image }}"
    source: build
    build:
      path: /vagrant/space2study-backend
      dockerfile: Dockerfile
    state: present
    force_source: yes

- name: Build frontend Docker image
  community.docker.docker_image:
    name: "{{ frontend_image }}"
    source: build
    build:
      path: /vagrant/space2study-frontend
      dockerfile: Dockerfile
    state: present
    force_source: yes

# Set up application directory structure
- name: Create application directories
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ app_user }}"
    group: "{{ app_user }}"
    mode: '0755'
  loop:
    - "{{ app_dir }}"
    - "{{ app_dir }}/nginx"
    - "{{ app_dir }}/frontend-static"

# Copy nginx config from synced folder
- name: Copy nginx load balancer config
  copy:
    src: /vagrant/nginx/nginx-lb.conf
    dest: "{{ app_dir }}/nginx/nginx-lb.conf"
    remote_src: yes
    owner: "{{ app_user }}"
    group: "{{ app_user }}"
    mode: '0644'

# Copy frontend static files from synced folder
- name: Copy frontend static files
  synchronize:
    src: /vagrant/frontend-static/
    dest: "{{ app_dir }}/frontend-static/"
    recursive: yes
  delegate_to: "{{ inventory_hostname }}"

# Copy docker-compose from role files
- name: Copy docker-compose.lb.yml
  copy:
    src: docker-compose.lb.yml
    dest: "{{ app_dir }}/docker-compose.lb.yml"
    owner: "{{ app_user }}"
    group: "{{ app_user }}"
    mode: '0644'

# Create .env file
- name: Create .env file
  template:
    src: env.j2
    dest: "{{ app_dir }}/.env"
    owner: "{{ app_user }}"
    group: "{{ app_user }}"
    mode: '0600'

# Pull required base images
- name: Pull MongoDB image
  community.docker.docker_image:
    name: mongo:4.4
    source: pull
    state: present

- name: Pull nginx image
  community.docker.docker_image:
    name: nginx:alpine
    source: pull
    state: present

# Deploy application
- name: Stop existing containers
  community.docker.docker_compose_v2:
    project_src: "{{ app_dir }}"
    files:
      - docker-compose.lb.yml
    state: absent
  ignore_errors: yes

- name: Deploy application with docker-compose
  community.docker.docker_compose_v2:
    project_src: "{{ app_dir }}"
    files:
      - docker-compose.lb.yml
    state: present
    pull: never
  register: compose_output

- name: Wait for services to be healthy
  pause:
    seconds: 45
    prompt: "Waiting for services to start..."

# Verify deployment
- name: Check container status
  command: docker ps --format "table {{ '{{' }}.Names{{ '}}' }}\t{{ '{{' }}.Status{{ '}}' }}"
  register: container_status
  changed_when: false

- name: Display container status
  debug:
    msg: "{{ container_status.stdout_lines }}"

- name: Test nginx health endpoint
  uri:
    url: "http://localhost:80/nginx-health"
    return_content: yes
  register: health_check
  retries: 5
  delay: 10
  until: health_check.status == 200

- name: Display health check result
  debug:
    msg: "Health check: {{ health_check.content }}"
